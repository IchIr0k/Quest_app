{% extends "base.html" %}
{% block title %}–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% endblock %}
{% block content %}
<div class="container">
    <h2>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>

<!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ -->
<div class="report-controls">
    <h3>–û—Ç—á–µ—Ç—ã –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º</h3>
    <div class="report-buttons">
        <a href="/admin/report/word" class="btn outline">
            üìÑ –û—Ç—á–µ—Ç –ø–æ –±—Ä–æ–Ω–∏ –≤ Word
        </a>
        <a href="/admin/report/excel" class="btn outline">
            üìä –û—Ç—á–µ—Ç –ø–æ –±—Ä–æ–Ω–∏ –≤ Excel
        </a>
        <a href="/admin/report/pdf" class="btn outline">
            üìë –û—Ç—á–µ—Ç –ø–æ –±—Ä–æ–Ω–∏ –≤ PDF
        </a>
    </div>
    <p class="report-info">–û—Ç—á–µ—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –¥–∞–Ω–Ω—ã–µ –æ –≤—Å–µ—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö, –∫–≤–µ—Å—Ç–∞—Ö –∏ –æ–±—â–µ–π –≤—ã—Ä—É—á–∫–µ.</p>
</div>

    {% if error %}
    <div class="alert error">
        {{ error }}

        {% if blocked_quest_id and quest_bookings %}
        <div style="margin-top: 15px; padding: 15px; background: #2a1a1a; border-radius: 6px;">
            <strong>–ê–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞:</strong>
            <div style="margin-top: 10px;">
                {% for booking in quest_bookings %}
                <div style="padding: 8px; margin: 5px 0; background: #3a2a2a; border-radius: 4px;">
                    üìÖ {{ booking.date_time }} - {{ booking.user.username }}
                    {% if booking.user.email %}({{ booking.user.email }}){% endif %}
                </div>
                {% endfor %}
            </div>

            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <form method="post" action="/admin/delete-all-bookings/{{ blocked_quest_id }}"
                      onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞?')">
                    <button type="submit" class="btn danger small">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
                </form>

                <form method="post" action="/admin/delete-quest-with-bookings/{{ blocked_quest_id }}"
                      onsubmit="return confirm('–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –∫–≤–µ—Å—Ç –∏ –í–°–ï –µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')">
                    <button type="submit" class="btn danger small">–£–¥–∞–ª–∏—Ç—å –∫–≤–µ—Å—Ç –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
                </form>

                <a href="/admin/bookings?quest_id={{ blocked_quest_id }}" class="btn outline small">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="admin-controls">
        <a href="/admin/add" class="btn">–î–æ–±–∞–≤–∏—Ç—å –∫–≤–µ—Å—Ç</a>
        <a href="/admin/bookings" class="btn outline">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏</a>
    </div>

    {% if error %}
    <div class="alert error">
        {{ error }}

        {% if blocked_quest_id and quest_bookings %}
        <div style="margin-top: 15px; padding: 15px; background: #2a1a1a; border-radius: 6px;">
            <strong>–ê–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞:</strong>
            <div style="margin-top: 10px;">
                {% for booking in quest_bookings %}
                <div style="padding: 8px; margin: 5px 0; background: #3a2a2a; border-radius: 4px;">
                    üìÖ {{ booking.date_time }} - {{ booking.user.username }}
                    {% if booking.user.email %}({{ booking.user.email }}){% endif %}
                </div>
                {% endfor %}
            </div>

            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <form method="post" action="/admin/delete-all-bookings/{{ blocked_quest_id }}"
                      onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞?')">
                    <button type="submit" class="btn danger small">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
                </form>

                <form method="post" action="/admin/delete-quest-with-bookings/{{ blocked_quest_id }}"
                      onsubmit="return confirm('–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –∫–≤–µ—Å—Ç –∏ –í–°–ï –µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')">
                    <button type="submit" class="btn danger small">–£–¥–∞–ª–∏—Ç—å –∫–≤–µ—Å—Ç –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
                </form>

                <a href="/admin/bookings?quest_id={{ blocked_quest_id }}" class="btn outline small">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="admin-list">
        {% for q in quests %}
        <div class="admin-item {% if blocked_quest_id == q.id %}highlighted{% endif %}">
            <div class="thumb">
                {% if q.image_path %}
                <img src="/static/{{ q.image_path }}" alt="{{ q.title }}">
                {% else %}
                <div class="card-placeholder small"></div>
                {% endif %}
            </div>
            <div class="info">
                <h4>{{ q.title }}</h4>
                <p class="meta">{{ q.genre }} ‚Ä¢ {{ q.difficulty }} ‚Ä¢ {{ q.players }} —á–µ–ª.</p>
                <div class="price-card">
                    <span class="price">{{ q.price }}‚ÇΩ</span>
                </div>

                {% set booking_count = namespace(value=0) %}
                {% for booking in quest_bookings if booking.quest_id == q.id %}
                    {% set booking_count.value = booking_count.value + 1 %}
                {% endfor %}

                {% if booking_count.value > 0 %}
                <div class="booking-badge">
                    üóìÔ∏è {{ booking_count.value }} –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
                </div>
                {% endif %}

                <div class="actions">
                    <a class="btn" href="/quest/{{ q.id }}">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                    <a class="btn outline" href="/admin/edit/{{ q.id }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <form style="display:inline" method="post" action="/admin/delete/{{ q.id }}"
                          onsubmit="return confirmDelete(this, '{{ q.title }}')">
                        <button class="btn danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
.report-controls {
    background: var(--panel);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
    border: 1px solid #39417b;
}

.report-controls h3 {
    margin: 0 0 15px 0;
    color: #e6e9fb;
    font-size: 1.2em;
}

.report-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.report-buttons .btn {
    flex: 1;
    min-width: 200px;
    padding: 12px 16px;
    text-align: center;
    font-size: 0.95em;
}

.report-info {
    margin: 15px 0 0 0;
    color: var(--muted);
    font-size: 0.9em;
    text-align: center;
}

.price-card {
    background: rgba(70, 80, 245, 0.2);
    padding: 8px 12px;
    border-radius: 8px;
    margin: 8px 0;
    border: 1px solid #4650f5;
    display: inline-block;
}

.price {
    color: var(--accent);
    font-weight: bold;
    font-size: 1.1em;
}
</style>

<script>
function showWordMessage() {
    alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –≤ Word –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Excel –∏–ª–∏ PDF –æ—Ç—á–µ—Ç—ã.');
    return false;
}

async function confirmDelete(form, questTitle) {
    const questId = form.action.split('/').pop();

    try {
        const response = await fetch(`/api/quest-has-bookings/${questId}`);
        const result = await response.json();

        if (result.has_bookings) {
            const userChoice = confirm(
                `–ö–≤–µ—Å—Ç "${questTitle}" –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.\n\n` +
                `‚Ä¢ –ù–∞–∂–º–∏—Ç–µ OK –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏\n` +
                `‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –û—Ç–º–µ–Ω–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã —É–¥–∞–ª–µ–Ω–∏—è`
            );

            if (userChoice) {
                window.location.href = `/admin#quest-${questId}`;
            }
            return false;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:', error);
    }

    return confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–≤–µ—Å—Ç "${questTitle}"?`);
}

document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const questId = urlParams.get('highlight');

    if (questId) {
        const element = document.getElementById(`quest-${questId}`);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth' });
        }
    }
});
</script>
{% endblock %}