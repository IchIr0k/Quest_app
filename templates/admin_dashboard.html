{% extends "base.html" %}
{% block title %}–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% endblock %}
{% block content %}
<div class="container">
    <h2>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>

    {% if error %}
    <div class="alert error">
        {{ error }}

        {% if blocked_quest_id and quest_bookings %}
        <div style="margin-top: 15px; padding: 15px; background: #2a1a1a; border-radius: 6px;">
            <strong>–ê–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞:</strong>
            <div style="margin-top: 10px;">
                {% for booking in quest_bookings %}
                <div style="padding: 8px; margin: 5px 0; background: #3a2a2a; border-radius: 4px;">
                    üìÖ {{ booking.date_time }} - {{ booking.user.username }}
                    {% if booking.user.email %}({{ booking.user.email }}){% endif %}
                </div>
                {% endfor %}
            </div>

            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <form method="post" action="/admin/delete-all-bookings/{{ blocked_quest_id }}"
                      onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –∫–≤–µ—Å—Ç–∞?')">
                    <button type="submit" class="btn danger small">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
                </form>

                <form method="post" action="/admin/delete-quest-with-bookings/{{ blocked_quest_id }}"
                      onsubmit="return confirm('–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –∫–≤–µ—Å—Ç –∏ –í–°–ï –µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')">
                    <button type="submit" class="btn danger small">–£–¥–∞–ª–∏—Ç—å –∫–≤–µ—Å—Ç –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
                </form>

                <a href="/admin/bookings?quest_id={{ blocked_quest_id }}" class="btn outline small">
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="admin-controls">
        <a href="/admin/add" class="btn">–î–æ–±–∞–≤–∏—Ç—å –∫–≤–µ—Å—Ç</a>
        <a href="/admin/bookings" class="btn outline">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏</a>
    </div>

    <div class="admin-list">
        {% for q in quests %}
        <div class="admin-item {% if blocked_quest_id == q.id %}highlighted{% endif %}">
            <div class="thumb">
                {% if q.image_path %}
                <img src="/static/{{ q.image_path }}" alt="{{ q.title }}">
                {% else %}
                <div class="card-placeholder small"></div>
                {% endif %}
            </div>
            <div class="info">
                <h4>{{ q.title }}</h4>
                <p class="meta">{{ q.genre }} ‚Ä¢ {{ q.difficulty }} ‚Ä¢ {{ q.players }} —á–µ–ª.</p>

                {% set booking_count = namespace(value=0) %}
                {% for booking in quest_bookings if booking.quest_id == q.id %}
                    {% set booking_count.value = booking_count.value + 1 %}
                {% endfor %}

                {% if booking_count.value > 0 %}
                <div class="booking-badge">
                    üóìÔ∏è {{ booking_count.value }} –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
                </div>
                {% endif %}

                <div class="actions">
                    <a class="btn" href="/quest/{{ q.id }}">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                    <a class="btn outline" href="/admin/edit/{{ q.id }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <form style="display:inline" method="post" action="/admin/delete/{{ q.id }}"
                          onsubmit="return confirmDelete(this, '{{ q.title }}')">
                        <button class="btn danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
.admin-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.admin-list {
    margin-top: 20px;
}

.admin-item {
    display: flex;
    align-items: center;
    padding: 15px;
    background: var(--card);
    border-radius: 8px;
    margin-bottom: 15px;
    border: 1px solid #39417b;
    transition: all 0.3s;
}

.admin-item.highlighted {
    border: 2px solid #dc3545;
    background: #2a1a1a;
}

.thumb {
    flex: 0 0 80px;
    margin-right: 20px;
}

.thumb img {
    width: 80px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
}

.card-placeholder.small {
    width: 80px;
    height: 60px;
    background: var(--panel);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
}

.info {
    flex: 1;
}

.info h4 {
    margin: 0 0 5px 0;
    color: #e6e9fb;
}

.meta {
    margin: 0 0 10px 0;
    color: #a0a7e6;
    font-size: 0.9em;
}

.booking-badge {
    display: inline-block;
    background: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    margin-bottom: 10px;
}

.actions {
    display: flex;
    gap: 10px;
}

.btn.danger {
    background: #dc3545;
    border-color: #dc3545;
}

.btn.danger:hover {
    background: #c82333;
    border-color: #bd2130;
}

.btn.small {
    padding: 6px 12px;
    font-size: 0.8em;
}

.alert.error {
    background: #3a1a1a;
    border: 1px solid #dc3545;
    color: lightpink;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
}
</style>

<script>
async function confirmDelete(form, questTitle) {
    const questId = form.action.split('/').pop();

    try {
        const response = await fetch(`/api/quest-has-bookings/${questId}`);
        const result = await response.json();

        if (result.has_bookings) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const userChoice = confirm(
                `–ö–≤–µ—Å—Ç "${questTitle}" –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.\n\n` +
                `‚Ä¢ –ù–∞–∂–º–∏—Ç–µ OK –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏\n` +
                `‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –û—Ç–º–µ–Ω–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã —É–¥–∞–ª–µ–Ω–∏—è`
            );

            if (userChoice) {
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ —ç—Ç–æ—Ç –∫–≤–µ—Å—Ç
                window.location.href = `/admin#quest-${questId}`;
            }
            return false;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:', error);
    }

    // –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    return confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–≤–µ—Å—Ç "${questTitle}"?`);
}

// –°–∫—Ä–æ–ª–ª –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º—É –∫–≤–µ—Å—Ç—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const questId = urlParams.get('highlight');

    if (questId) {
        const element = document.getElementById(`quest-${questId}`);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth' });
        }
    }
});
</script>
{% endblock %}