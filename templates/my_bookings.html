{% extends "base.html" %}
{% block title %}–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è{% endblock %}
{% block content %}
<div class="container">
    <h2>–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
    
    {% if bookings %}
    <div class="bookings-list">
        {% for booking in bookings %}
        <div class="booking-item">
            <div class="booking-info">
                <h4>{{ booking.quest.title }}</h4>
                <p class="meta">
                    <strong>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</strong> {{ booking.date_time }}<br>
                    <strong>–ñ–∞–Ω—Ä:</strong> {{ booking.quest.genre }}<br>
                    <strong>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</strong> {{ booking.quest.difficulty }}<br>
                    <strong>–ò–≥—Ä–æ–∫–æ–≤:</strong> –¥–æ {{ booking.quest.players }} —á–µ–ª–æ–≤–µ–∫<br>
                    <strong>–¶–µ–Ω–∞:</strong> {{ booking.quest.price }}‚ÇΩ
                </p>
            </div>
            <div class="booking-status">
                {% set booking_date = booking.date_time.split(' ')[0] %}
                {% set booking_time = booking.date_time.split(' ')[1] %}
                {% set is_past = booking_date < now().strftime('%Y-%m-%d') or
                                (booking_date == now().strftime('%Y-%m-%d') and booking_time < now().strftime('%H:%M')) %}

                {% if is_past %}
                <span class="status past">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                {% else %}
                <span class="status upcoming">–ü—Ä–µ–¥—Å—Ç–æ–∏—Ç</span>
                {% endif %}

                <div class="booking-actions">
                    <button class="btn outline small download-statement"
                            data-quest-title="{{ booking.quest.title }}"
                            data-quest-price="{{ booking.quest.price }}">
                        üìÑ –°–∫–∞—á–∞—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏–µ
                    </button>
                    <button class="btn outline small download-receipt"
                            data-quest-title="{{ booking.quest.title }}"
                            data-quest-price="{{ booking.quest.price }}">
                        üßæ –°–∫–∞—á–∞—Ç—å —á–µ–∫
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-bookings">
        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.</p>
        <a href="/" class="btn">–ù–∞–π—Ç–∏ –∫–≤–µ—Å—Ç</a>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö -->
<div id="statementModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>–î–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞—è–≤–ª–µ–Ω–∏—è</h3>
        <form id="statementForm">
            <input type="hidden" id="questTitle" name="quest_title">
            <input type="hidden" id="questPrice" name="quest_price">

            <label>
                –§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ:
                <input type="text" id="fullName" name="full_name" required
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û">
            </label>

            <label>
                –°–µ—Ä–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞:
                <input type="text" id="passportSeries" name="passport_series" required
                       placeholder="XXXX" maxlength="4" pattern="[0-9]{4}">
            </label>

            <label>
                –ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞:
                <input type="text" id="passportNumber" name="passport_number" required
                       placeholder="XXXXXX" maxlength="6" pattern="[0-9]{6}">
            </label>

            <div class="modal-actions">
                <button type="submit" class="btn">–°–∫–∞—á–∞—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏–µ</button>
                <button type="button" class="btn outline cancel">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<style>
.bookings-list {
    margin-top: 20px;
}

.booking-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 20px;
    background: var(--card);
    border-radius: 8px;
    margin-bottom: 15px;
    border: 1px solid #39417b;
}

.booking-info h4 {
    margin: 0 0 10px 0;
    color: #e6e9fb;
    font-size: 1.2em;
}

.booking-info .meta {
    margin: 0;
    color: #a0a7e6;
    line-height: 1.5;
}

.booking-status {
    flex-shrink: 0;
    margin-left: 20px;
    text-align: center;
}

.status {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9em;
    margin-bottom: 10px;
    display: block;
}

.status.upcoming {
    background: #28a745;
    color: white;
}

.status.past {
    background: #6c757d;
    color: white;
}

.booking-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.btn.small {
    padding: 8px 12px;
    font-size: 0.8em;
    white-space: nowrap;
}

/* –°—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: var(--panel);
    margin: 5% auto;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    border: 1px solid #39417b;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #e6e9fb;
}

.modal-content h3 {
    margin-top: 0;
    color: #e6e9fb;
}

.modal-content label {
    display: block;
    margin-bottom: 15px;
    color: #e6e9fb;
}

.modal-content input {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border: 1px solid #39417b;
    border-radius: 6px;
    background: #0b1330;
    color: #e6e9fb;
    box-sizing: border-box;
}

.modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.modal-actions .btn {
    flex: 1;
}

.no-bookings {
    text-align: center;
    padding: 40px;
    background: var(--card);
    border-radius: 8px;
    border: 1px solid #39417b;
}

.no-bookings p {
    margin-bottom: 20px;
    color: #a0a7e6;
    font-size: 1.1em;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('statementModal');
    const closeBtn = document.querySelector('.close');
    const cancelBtn = document.querySelector('.cancel');
    const statementForm = document.getElementById('statementForm');

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∑–∞—è–≤–ª–µ–Ω–∏—è
    document.querySelectorAll('.download-statement').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('questTitle').value = this.dataset.questTitle;
            document.getElementById('questPrice').value = this.dataset.questPrice;
            modal.style.display = 'block';
        });
    });

    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —á–µ–∫–∞
    document.querySelectorAll('.download-receipt').forEach(btn => {
        btn.addEventListener('click', function() {
            const questTitle = this.dataset.questTitle;
            const questPrice = this.dataset.questPrice;

            fetch('/download-receipt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    quest_title: questTitle,
                    quest_price: questPrice
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `—á–µ–∫_${questTitle.replace(/\s+/g, '_')}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    closeBtn.addEventListener('click', () => modal.style.display = 'none');
    cancelBtn.addEventListener('click', () => modal.style.display = 'none');

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–∫–Ω–∞
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞—è–≤–ª–µ–Ω–∏—è
    statementForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = {
            full_name: document.getElementById('fullName').value,
            passport_series: document.getElementById('passportSeries').value,
            passport_number: document.getElementById('passportNumber').value,
            quest_title: document.getElementById('questTitle').value,
            quest_price: document.getElementById('questPrice').value
        };

        fetch('/download-statement', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `–∑–∞—è–≤–ª–µ–Ω–∏–µ_${formData.quest_title.replace(/\s+/g, '_')}.docx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            modal.style.display = 'none';
            statementForm.reset();
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
    });
});
</script>
{% endblock %}